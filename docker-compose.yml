# ============================================
# Docker Compose - Impostor Backend
# Desarrollo: Usa MySQL local del host
# Producción: Añadir servicio mysql separado
# ============================================

services:
  # ========== Backend API ==========
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: impostor-backend
    restart: unless-stopped
    environment:
      # Database - Conecta a MySQL local del host
      DB_HOST: host.docker.internal
      DB_PORT: 3306
      DB_NAME: ${DB_NAME:-impostor}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD}
      # JWT (IMPORTANTE: cambiar en producción)
      JWT_SECRET: ${JWT_SECRET}
      # Google OAuth2
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_ANDROID_CLIENT_ID: ${GOOGLE_ANDROID_CLIENT_ID:-}
      GOOGLE_IOS_CLIENT_ID: ${GOOGLE_IOS_CLIENT_ID:-}
      # CORS (dominios permitidos, separados por coma)
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000}
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      SECURITY_LOG_LEVEL: ${SECURITY_LOG_LEVEL:-WARN}
      # Spring
      SPRING_PROFILES_ACTIVE: prod
      # JVM
      JAVA_OPTS: "-Xmx512m -Xms256m -XX:+UseG1GC -XX:+HeapDumpOnOutOfMemoryError"
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# ========== Networks ==========
# No se necesita red personalizada para un solo servicio
# networks:
#   impostor-network:
#     driver: bridge

# ========== Volumes ==========
# No se necesita volumen de MySQL (usa BD local del host)
# volumes:
#   mysql_data:
#     driver: local
